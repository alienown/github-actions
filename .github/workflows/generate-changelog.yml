name: Generate Changelog

on:
  workflow_dispatch:
    inputs:
      action-name:
        description: 'Name of the action (e.g., generate-changelog) that will have its changelog updated. Leave empty to detect from recent changes.'
        required: false
        type: string
      pr-number:
        description: 'Pull request number to generate changelog for'
        required: false
        type: number

jobs:
  detect-changes:
    if: ${{ !inputs.action-name }}
    uses: ./.github/workflows/detect-changes.yml
    with:
      base-ref: ${{ github.base_ref || 'main' }}

  generate-changelogs:
    needs: detect-changes
    if: always() && (needs.detect-changes.outputs.actions != '[]' || inputs.action-name)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      matrix:
        action: ${{ inputs.action-name && fromJson(format('["{0}"]', inputs.action-name)) || fromJson(needs.detect-changes.outputs.actions) }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Changelog for ${{ matrix.action }}
        uses: ./generate-changelog
        with:
          openrouter-api-key: ${{ secrets.OPENROUTER_API_KEY }}
          github-token: ${{ github.token }}
          version-file: '${{ matrix.action }}/package.json'
          changelog-path: '${{ matrix.action }}/CHANGELOG.md'
          pr-number: ${{ inputs.pr-number }}
